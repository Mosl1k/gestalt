{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "gestalt.fullname" . }}-shopping-backup
  labels:
    {{- include "gestalt.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  schedule: "*/20 * * * *"  # –ö–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "gestalt.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: redis:latest
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              BACKUP_DIR="/mnt/yandex/gestalt"
              BACKUP_FILE="$BACKUP_DIR/shopping.txt"
              TEMP_FILE="/tmp/shopping_backup_$$.txt"
              
              # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
              mkdir -p "$BACKUP_DIR"
              
              # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å Redis
              REDIS_PASSWORD=$(cat /etc/redis-password/password)
              REDIS_HOST="{{ include "gestalt.fullname" . }}-redis"
              REDIS_PORT="6379"
              
              # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
              get_redis_data() {
                local key=$1
                redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" GET "$key" 2>/dev/null || echo ""
              }
              
              # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ —Å–ø–∏—Å–∫–æ–≤
              LIST_KEYS=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" KEYS "shoppingList:*" 2>/dev/null || echo "")
              
              if [ -z "$LIST_KEYS" ]; then
                echo "–°–ø–∏—Å–∫–∏ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç—ã"
                exit 0
              fi
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞
              {
                echo "=== –ë—ç–∫–∞–ø —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫ ==="
                echo "–î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
                echo ""
                
                for key in $LIST_KEYS; do
                  IFS=':' read -r prefix user_id category <<< "$key"
                  list_data=$(get_redis_data "$key")
                  
                  if [ -z "$list_data" ] || [ "$list_data" = "null" ]; then
                    continue
                  fi
                  
                  echo "--- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $user_id | –ö–∞—Ç–µ–≥–æ—Ä–∏—è: $category ---"
                  
                  # –ü–∞—Ä—Å–∏–º JSON —á–µ—Ä–µ–∑ Python (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–±—Ä–∞–∑–µ)
                  if command -v python3 >/dev/null 2>&1; then
                    echo "$list_data" | python3 -c "
import json
import sys
try:
    data = json.load(sys.stdin)
    if isinstance(data, list):
        for item in data:
            status = '‚úì' if item.get('bought', False) else '‚òê'
            priority = 'üî•' if item.get('priority', 2) == 3 else ('üü°' if item.get('priority', 2) == 2 else 'üü¢')
            print(f\"  {status} {priority} {item.get('name', '')}\")
except:
    print(f\"  {sys.stdin.read()}\")
" 2>/dev/null || echo "  $list_data"
                  else
                    echo "  $list_data"
                  fi
                  
                  echo ""
                done
                
                echo "=== –ö–æ–Ω–µ—Ü –±—ç–∫–∞–ø–∞ ==="
              } > "$TEMP_FILE"
              
              mv "$TEMP_FILE" "$BACKUP_FILE"
              echo "–ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ $BACKUP_FILE"
            volumeMounts:
            - name: yandex-mount
              mountPath: /mnt/yandex
            - name: redis-password
              mountPath: /etc/redis-password
              readOnly: true
          volumes:
          - name: yandex-mount
            hostPath:
              path: /mnt/yandex
              type: DirectoryOrCreate
          - name: redis-password
            secret:
              secretName: {{ include "gestalt.fullname" . }}-secrets
              items:
              - key: REDIS_PASSWORD
                path: password
{{- end }}

