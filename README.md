# Gestalt - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞–º–∏ –ø–æ–∫—É–ø–æ–∫

–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞–º–∏ –ø–æ–∫—É–ø–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:
- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (OAuth2 —á–µ—Ä–µ–∑ Yandex)
- –¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç
- –ù–∞–≤—ã–∫ –Ø–Ω–¥–µ–∫—Å –ê–ª–∏—Å—ã

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
gestalt/
‚îú‚îÄ‚îÄ backend/              # Go –±–µ–∫–µ–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ main.go          # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ go.mod           # Go –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ go.sum
‚îú‚îÄ‚îÄ frontend/            # –§—Ä–æ–Ω—Ç–µ–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ index.html       # HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îú‚îÄ‚îÄ services/            # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ alice/          # –°–µ—Ä–≤–∏—Å –¥–ª—è –Ø–Ω–¥–µ–∫—Å –ê–ª–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alice.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot/   # –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç
‚îÇ       ‚îú‚îÄ‚îÄ telegram_bot.py
‚îÇ       ‚îî‚îÄ‚îÄ requirements_bot.txt
‚îú‚îÄ‚îÄ docker/              # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yaml
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile       # –ë–µ–∫–µ–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.bot   # –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.python # –ê–ª–∏—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile.nginx # Nginx
‚îú‚îÄ‚îÄ infra/               # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îî‚îÄ‚îÄ redis/
‚îÇ       ‚îú‚îÄ‚îÄ redis.conf
‚îÇ       ‚îî‚îÄ‚îÄ backup_redis.sh
‚îî‚îÄ‚îÄ scripts/             # –°–∫—Ä–∏–ø—Ç—ã
    ‚îú‚îÄ‚îÄ deploy.sh        # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
    ‚îú‚îÄ‚îÄ check-callback.sh
    ‚îú‚îÄ‚îÄ deploy-to-server.sh
    ‚îî‚îÄ‚îÄ sync-server.sh
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### API Endpoints

1. **–ü—É–±–ª–∏—á–Ω—ã–µ endpoints** (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏):
   - `GET /` - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
   - `GET /auth/yandex` - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Yandex OAuth
   - `GET /auth/yandex/callback` - Callback –æ—Ç Yandex
   - `GET /logout` - –í—ã—Ö–æ–¥

2. **–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints** (OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è):
   - `GET /list?category=...` - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫
   - `POST /add` - –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç
   - `PUT /buy/{name}` - –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∫—É–ø–ª–µ–Ω–Ω–æ–µ
   - `DELETE /delete/{name}?category=...` - –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç
   - `PUT /edit/{name}?oldCategory=...` - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç
   - `POST /reorder` - –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - API –¥–ª—è –¥—Ä—É–∑–µ–π: `/api/user`, `/api/friends/*`, `/api/users/*`, `/api/shared-lists`, `/api/share-list`

3. **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ API endpoints** (—Ç–æ–ª—å–∫–æ –∏–∑ Docker —Å–µ—Ç–∏, –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏):
   - `GET /internal/api/list?category=...` - –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
   - `POST /internal/api/add` - –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
   - `PUT /internal/api/buy/{name}` - –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
   - `DELETE /internal/api/delete/{name}?category=...` - –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
   - `PUT /internal/api/edit/{name}?oldCategory=...` - –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤

### –°–µ—Ä–≤–∏—Å—ã

- **geshtalt** (Go –±–µ–∫–µ–Ω–¥) - –æ—Å–Ω–æ–≤–Ω–æ–π API —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8080
- **redis** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **alice** (Python Flask) - —Å–µ—Ä–≤–∏—Å –¥–ª—è –Ø–Ω–¥–µ–∫—Å –ê–ª–∏—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 2112
- **telegram-bot** (Python) - —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç
- **nginx** - reverse proxy –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 80/443

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (—Å–º. `.env.example`)
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ Docker Compose:

```bash
cd docker
docker-compose up --build
```

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:

```bash
sudo ./scripts/deploy.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç Docker –∏ Docker Compose
- –ù–∞—Å—Ç—Ä–æ–∏—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- –°–∫–∞—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø Redis –∏–∑ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ
- –°–∫–∞—á–∞–µ—Ç `.env` —Ñ–∞–π–ª –∏–∑ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ Redis
- –ó–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

### –£–º–Ω—ã–π –¥–µ–ø–ª–æ–π (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–º–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
./scripts/smart-deploy.sh

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./scripts/smart-deploy.sh --force
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π - –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- üéØ –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç git diff
- üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è - Redis –∏ nginx (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞) —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è
- üì¶ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [scripts/README.md](scripts/README.md)

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# Redis
REDIS_ADDR=redis:6379
REDIS_PASSWORD=your_redis_password

# Yandex OAuth
YANDEX_CLIENT_ID=your_client_id
YANDEX_CLIENT_SECRET=your_client_secret
YANDEX_CALLBACK_URL=https://kpalch.ru/auth/yandex/callback

# Session
SESSION_SECRET=your_session_secret_min_32_chars

# Telegram Bot
TELEGRAM_TOKEN=your_telegram_token
API_URL=http://geshtalt:8080/internal/api
SERVICE_USER_ID=your_service_user_id  # User ID –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

## –ë—ç–∫–∞–ø—ã

–ë—ç–∫–∞–ø—ã Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ `/mnt/yandex/backup/` (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ).

–î–ª—è —Ä—É—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞:
```bash
./infra/redis/backup_redis.sh
```

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ –¥–æ–±–∞–≤—å—Ç–µ –≤ crontab:
```bash
0 2 * * * /bin/bash /root/gestalt/infra/redis/backup_redis.sh >> /mnt/yandex/backup/backup.log 2>&1
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –≤ `services/`
2. –°–æ–∑–¥–∞–π—Ç–µ Dockerfile –≤ `docker/`
3. –î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–≤–∏—Å –≤ `docker/docker-compose.yaml`
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API: `http://geshtalt:8080/internal/api/...`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–µ–∫–µ–Ω–¥–∞

1. –ò–∑–º–µ–Ω–∏—Ç–µ –∫–æ–¥ –≤ `backend/main.go`
2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑: `cd docker && docker-compose build geshtalt`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose restart geshtalt`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

1. –ò–∑–º–µ–Ω–∏—Ç–µ `frontend/index.html`
2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑: `cd docker && docker-compose build geshtalt`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose restart geshtalt`

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OAuth2 —á–µ—Ä–µ–∑ Yandex
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ API –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑ Docker —Å–µ—Ç–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ IP –∞–¥—Ä–µ—Å—É)
- –°–µ—Ä–≤–∏—Å—ã –æ–±—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é Docker —Å–µ—Ç—å
- SSL/TLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ nginx —Å Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TELEGRAM_TOKEN` –≤ `.env`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `API_URL=http://geshtalt:8080/internal/api`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs telegram-bot`

### –ê–ª–∏—Å–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs alice`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `/alice/`

### Redis –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –±—ç–∫–∞–ø–æ–≤ –≤ `/mnt/yandex/backup/`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –±—ç–∫–∞–ø–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Redis: `docker-compose logs redis`

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
