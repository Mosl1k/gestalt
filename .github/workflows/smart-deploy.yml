name: Smart Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # Нужно для сравнения коммитов
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no root@kpalch.ru << 'EOF'
          cd /root/gestalt || exit 1
          
          # Получаем последние изменения
          git fetch origin
          git pull origin main
          
          # Запускаем умный деплой
          chmod +x scripts/smart-deploy.sh
          ./scripts/smart-deploy.sh origin/main
        EOF

